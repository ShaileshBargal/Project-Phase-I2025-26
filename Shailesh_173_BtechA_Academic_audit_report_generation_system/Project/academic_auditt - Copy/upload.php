<?php session_start(); require_once "db.php"; require 'vendor/autoload.php'; // PHPMailer & Dompdf use PHPMailer\PHPMailer\PHPMailer; use PHPMailer\PHPMailer\Exception; use Dompdf\Dompdf; use Dompdf\Options; if (!isset($_SESSION['teacher_id'])) { header("Location: teacher_login.php"); exit; } $user_id = (int)$_SESSION['teacher_id']; $teacher_name = $_SESSION['username'] ?? 'Unknown Incharge'; if ($_SERVER['REQUEST_METHOD'] !== 'POST') { header("Location: teacher.php"); exit; } $title = trim($_POST['title'] ?? ''); $semester = $_POST['semester'] ?? ''; $year = $_POST['year'] ?? ''; $file = $_FILES['report'] ?? null; $errors = []; if ($title === '') $errors[] = "Title is required."; if (!in_array($semester, ['even', 'odd'])) $errors[] = "Invalid semester."; if (!in_array($year, ['2024', '2025'])) $errors[] = "Invalid year."; if (!$file || $file['error'] !== 0) $errors[] = "File upload failed."; $allowed_ext = ['pdf', 'doc', 'docx']; $max_size = 10 * 1024 * 1024; $ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION)); if (!in_array($ext, $allowed_ext)) $errors[] = "Invalid file type."; if ($file['size'] > $max_size) $errors[] = "File too large."; if (!empty($errors)) { echo "<h3>Errors:</h3><ul>"; foreach ($errors as $e) echo "<li>" . htmlspecialchars($e) . "</li>"; echo "</ul><a href='teacher.php'>Go Back</a>"; exit; } $upload_dir = __DIR__ . '/uploads'; $pdf_dir = __DIR__ . '/generated_pdfs'; if (!is_dir($upload_dir)) mkdir($upload_dir, 0777, true); if (!is_dir($pdf_dir)) mkdir($pdf_dir, 0777, true); $new_filename = time() . "_" . preg_replace("/[^a-zA-Z0-9._-]/", "_", $file['name']); $dest = $upload_dir . '/' . $new_filename; if (!move_uploaded_file($file['tmp_name'], $dest)) { die("Failed to move uploaded file."); } // ✅ Create Summary PDF $options = new Options(); $options->set('isRemoteEnabled', true); $dompdf = new Dompdf($options); $html = " <h2 style='text-align:center;'>Academic Audit Report Summary</h2> <p><b>Incharge:</b> $teacher_name</p> <p><b>Title:</b> $title</p> <p><b>Semester:</b> $semester</p> <p><b>Year:</b> $year</p> <p><b>Uploaded File:</b> $new_filename</p> <p><b>Submitted At:</b> " . date('Y-m-d H:i:s') . "</p> "; $dompdf->loadHtml($html); $dompdf->setPaper('A4', 'portrait'); $dompdf->render(); $pdf_filename = "summary_" . time() . ".pdf"; $pdf_path = $pdf_dir . "/" . $pdf_filename; file_put_contents($pdf_path, $dompdf->output()); // ✅ Save to database $stmt = $conn->prepare("INSERT INTO reports (teacher_id, title, filename, summary_pdf, semester, year, status, submitted_at) VALUES (?, ?, ?, ?, ?, ?, 'pending', NOW())"); $stmt->bind_param("isssss", $user_id, $title, $new_filename, $pdf_filename, $semester, $year); $stmt->execute(); // ✅ Notify Head via email & SMS if ($stmt->affected_rows > 0) { $head_email = "shaileshbargal@gmail.com"; $head_phone = "8767166538"; try { $mail = new PHPMailer(true); $mail->isSMTP(); $mail->Host = 'smtp.gmail.com'; $mail->Port = 587; $mail->SMTPAuth = true; $mail->SMTPSecure = 'tls'; $mail->Username = 'shaileshbargal19@gmail.com'; $mail->Password = 'nrhtsgmmwwflaelx'; $mail->setFrom('shaileshbargal19@gmail.com', 'Academic Audit System'); $mail->addAddress($head_email); $mail->isHTML(true); $mail->Subject = "New Report Uploaded by $teacher_name"; $mail->Body = " <h3>New Report Uploaded</h3> <p><b>Incharge:</b> $teacher_name</p> <p><b>Title:</b> $title</p> <p><b>Year:</b> $year</p> <p><b>Semester:</b> $semester</p> <p>A summary PDF has been generated and is available in your dashboard.</p> "; $mail->send(); } catch (Exception $e) { error_log("Mail Error: " . $mail->ErrorInfo); } // SMS (optional) $api_key = "YOUR_FAST2SMS_API_KEY"; $message = "New report by $teacher_name: '$title'. Please review."; $curl = curl_init(); curl_setopt_array($curl, [ CURLOPT_URL => "https://www.fast2sms.com/dev/bulkV2", CURLOPT_RETURNTRANSFER => true, CURLOPT_POST => true, CURLOPT_POSTFIELDS => http_build_query([ "sender_id" => "TXTIND", "message" => $message, "language" => "english", "route" => "v3", "numbers" => $head_phone, ]), CURLOPT_HTTPHEADER => ["authorization: $api_key"], ]); curl_exec($curl); curl_close($curl); header("Location: teacher.php?success=1"); exit; } else { die("Database error: " . $conn->error); } ?>